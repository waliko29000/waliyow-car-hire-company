<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Help Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .help-container {
      background: white;
      padding: 30px 25px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      max-width: 420px;
      width: 90%;
      position: relative;
      box-sizing: border-box;
    }
    .close-btn {
      position: absolute;
      top: 12px;
      right: 15px;
      font-size: 22px;
      font-weight: bold;
      color: #333;
      text-decoration: none;
      background: #e0e0e0;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
    }
    .close-btn:hover { background: #007bff; color: white; cursor: pointer; }
    .note {
      background: #e6f2ff;
      padding: 12px 15px;
      border-left: 5px solid #007bff;
      margin-bottom: 20px;
      font-size: 15px;
      color: #333;
      border-radius: 5px;
    }
    h2 { text-align: center; margin-bottom: 15px; color: #333; }
    textarea {
      width: 100%; height: 120px; padding: 10px;
      border: 1px solid #ccc; border-radius: 8px;
      font-size: 16px; resize: none; margin-bottom: 15px; box-sizing: border-box;
    }
    button {
      width: 100%; padding: 12px; background-color: #007bff;
      color: white; font-size: 16px; border: none;
      border-radius: 8px; cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    .message-box {
      margin-top: 15px; padding: 12px;
      background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;
    }
    .reply {
      margin-top: 10px; padding: 10px;
      background: #e6f7ff; border-radius: 6px;
    }
    .blocked {
      text-align: center;
      color: red;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div class="help-container" id="helpContainer">
  <a href="car-available.html" class="close-btn">&times;</a>

  <div class="note">
    <strong>Need Help?</strong>
    If you're experiencing any issues with our system, please describe your problem below and submit it.  
    For urgent support, you can also call us directly at <b><a href="tel:0729177741">0729177741</a></b>.
  </div>

  <h2>Help Center</h2>
  <div id="statusMessage"></div>
  <div id="helpForm">
    <textarea id="problem" placeholder="Describe your problem here..."></textarea>
    <button onclick="submitProblem()">Submit</button>
  </div>

  <div id="userMessages"></div>
</div>

<script>
  const problemsKey = "helpMessages";
  let currentUser = JSON.parse(localStorage.getItem("currentUser"));

 if (!currentUser) {
  // 1. Replace the page content with the warning box
  document.body.innerHTML = `
    <div style="background-color: #fff5f5; border: 2px solid #feb2b2; padding: 40px; margin: 100px auto; max-width: 500px; border-radius: 15px; font-family: system-ui, sans-serif; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      <h2 style="text-align: center; color: #c53030; margin: 0;">
        ‚ö†Ô∏è Please sign in first to access Help services!
      </h2>
      <p style="text-align: center; color: #742a2a; margin-top: 20px; font-weight: 500;">
        Redirecting you to the sign-in page...
      </p>
      <div style="display: flex; justify-content: center; margin-top: 20px;">
         <div style="width: 40px; height: 40px; border: 4px solid #fbb6ce; border-top: 4px solid #c53030; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      </div>
    </div>
    <style>
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  `;

  // 2. Redirect to signin.html after 7 seconds
  setTimeout(() => {
    window.location.href = "signin.html";
  }, 7000);
}
  // üîπ Always refresh currentUser status from allUsers
  function refreshCurrentUser() {
    const allUsers = JSON.parse(localStorage.getItem("allUsers")) || [];
    const freshUser = allUsers.find(u => u.email === currentUser.email);
    if (freshUser) {
      currentUser = freshUser;
      localStorage.setItem("currentUser", JSON.stringify(freshUser)); // keep synced
    }
  }

  // Check suspension/expulsion
  function checkStatus() {
    const statusMessage = document.getElementById("statusMessage");
    const helpForm = document.getElementById("helpForm");

    if (currentUser && currentUser.status === "Suspended") {
      statusMessage.innerHTML = "<p class='blocked'>‚ö†Ô∏è Your account has been suspended. You cannot submit help requests.</p>";
      helpForm.style.display = "none";
    } else if (currentUser && currentUser.status === "Expelled") {
      document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:50px;'>‚ùå Your account has been expelled. You cannot access this system.</h2>";
    } else {
      statusMessage.innerHTML = "";
      helpForm.style.display = "block";
    }
  }

  function submitProblem() {
    const problemText = document.getElementById("problem").value.trim();
    if (!problemText) { alert("Please describe your problem."); return; }

    let problems = JSON.parse(localStorage.getItem(problemsKey)) || [];

    problems.push({
      username: currentUser.username,
      email: currentUser.email,
      phone: currentUser.phone,
      message: problemText,
      reply: ""
    });

    localStorage.setItem(problemsKey, JSON.stringify(problems));
    document.getElementById("problem").value = "";
    renderUserMessages();
  }

  function renderUserMessages() {
    let problems = JSON.parse(localStorage.getItem(problemsKey)) || [];
    let container = document.getElementById("userMessages");
    container.innerHTML = "";

    problems.filter(p => p.email === currentUser.email).forEach(p => {
      let div = document.createElement("div");
      div.className = "message-box";
      div.innerHTML = `<b>Your message:</b> ${p.message}`;
      if (p.reply) {
        div.innerHTML += `<div class="reply"><b>Admin reply:</b> ${p.reply}</div>`;
      }
      container.appendChild(div);
    });
  }

  // üîÑ Live check for suspension and replies
  function liveCheck() {
    refreshCurrentUser();  
    checkStatus();         
    renderUserMessages();  // ‚úÖ keep replies updated live
  }

  // Run
  if (currentUser) {
    liveCheck();
    setInterval(liveCheck, 2000); // check every 2s
  }
</script>

</body>
</html>
